<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="diff –git a&#x2F;Makefile.target b&#x2F;Makefile.targetindex 933b27453a..9abc61a870 100644— a&#x2F;Makefile.target+++ b&#x2F;Makefile.target@@ -152,7 +152,7 @@ endif #CONFIG_BSD_USER #################">
<meta property="og:type" content="article">
<meta property="og:title" content="libvmi_patch">
<meta property="og:url" content="http://example.com/articles/2022/06/27/libvmi-patch/index.html">
<meta property="og:site_name" content="AGan">
<meta property="og:description" content="diff –git a&#x2F;Makefile.target b&#x2F;Makefile.targetindex 933b27453a..9abc61a870 100644— a&#x2F;Makefile.target+++ b&#x2F;Makefile.target@@ -152,7 +152,7 @@ endif #CONFIG_BSD_USER #################">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-06-27T07:47:21.000Z">
<meta property="article:modified_time" content="2022-06-27T07:47:48.909Z">
<meta property="article:author" content="Gan Chengyu">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="kvm">
<meta property="article:tag" content="libvmi">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/articles/2022/06/27/libvmi-patch/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/articles/2022/06/27/libvmi-patch/","path":"articles/2022/06/27/libvmi-patch/","title":"libvmi_patch"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>libvmi_patch | AGan</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">AGan</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#System-emulator-target"><span class="nav-number">1.</span> <span class="nav-text">System emulator target</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%98include%E2%80%99-%E2%80%98libvmi-json%E2%80%99"><span class="nav-number">1.1.</span> <span class="nav-text">+{ ‘include’: ‘libvmi.json’ }</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Gan Chengyu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Gan Chengyu</p>
  <div class="site-description" itemprop="description">Recording what I did</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/articles/2022/06/27/libvmi-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Gan Chengyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AGan">
      <meta itemprop="description" content="Recording what I did">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="libvmi_patch | AGan">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          libvmi_patch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-27 15:47:21 / Modified: 15:47:48" itemprop="dateCreated datePublished" datetime="2022-06-27T15:47:21+08:00">2022-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>diff –git a&#x2F;Makefile.target b&#x2F;Makefile.target<br>index 933b27453a..9abc61a870 100644<br>— a&#x2F;Makefile.target<br>+++ b&#x2F;Makefile.target<br>@@ -152,7 +152,7 @@ endif #CONFIG_BSD_USER<br> #########################################################</p>
<h1 id="System-emulator-target"><a href="#System-emulator-target" class="headerlink" title="System emulator target"></a>System emulator target</h1><p> ifdef CONFIG_SOFTMMU<br>-obj-y +&#x3D; arch_init.o cpus.o gdbstub.o balloon.o ioport.o<br>+obj-y +&#x3D; arch_init.o cpus.o gdbstub.o balloon.o ioport.o memory-access.o<br> obj-y +&#x3D; qtest.o<br> obj-y +&#x3D; dump&#x2F;<br> obj-y +&#x3D; hw&#x2F;<br>diff –git a&#x2F;include&#x2F;monitor&#x2F;hmp.h b&#x2F;include&#x2F;monitor&#x2F;hmp.h<br>index a0e9511440..73d5297173 100644<br>— a&#x2F;include&#x2F;monitor&#x2F;hmp.h<br>+++ b&#x2F;include&#x2F;monitor&#x2F;hmp.h<br>@@ -52,6 +52,7 @@ void hmp_announce_self(Monitor *mon, const QDict *qdict);<br> void hmp_cpu(Monitor *mon, const QDict *qdict);<br> void hmp_memsave(Monitor *mon, const QDict *qdict);<br> void hmp_pmemsave(Monitor *mon, const QDict *qdict);<br>+void hmp_pmemaccess(Monitor *mon, const QDict *qdict);<br> void hmp_ringbuf_write(Monitor *mon, const QDict *qdict);<br> void hmp_ringbuf_read(Monitor *mon, const QDict *qdict);<br> void hmp_cont(Monitor *mon, const QDict *qdict);<br>diff –git a&#x2F;libvmi_request.h b&#x2F;libvmi_request.h<br>new file mode 100644<br>index 0000000000..0770cff55d<br>— &#x2F;dev&#x2F;null<br>+++ b&#x2F;libvmi_request.h<br>@@ -0,0 +1,10 @@<br>+#ifndef LIBVMI_REQUEST_H<br>+#define LIBVMI_REQUEST_H<br>+<br>+struct request {</p>
<ul>
<li>uint64_t type;      &#x2F;&#x2F; 0 quit, 1 read, 2 write, … rest reserved</li>
<li>uint64_t address;  &#x2F;&#x2F; address to read from OR write to</li>
<li>uint64_t length;   &#x2F;&#x2F; number of bytes to read OR write<br>+};</li>
<li>+#endif &#x2F;* LIBVMI_REQUEST_H <em>&#x2F;<br>diff –git a&#x2F;memory-access.c b&#x2F;memory-access.c<br>new file mode 100644<br>index 0000000000..72ac93ae2c<br>— &#x2F;dev&#x2F;null<br>+++ b&#x2F;memory-access.c<br>@@ -0,0 +1,249 @@<br>+&#x2F;</em></li>
<li><ul>
<li>Access guest physical memory via a domain socket.</li>
</ul>
</li>
<li><ul>
<li></li>
</ul>
</li>
<li><ul>
<li>Copyright (C) 2011 Sandia National Laboratories</li>
</ul>
</li>
<li><ul>
<li>Original Author: Bryan D. Payne (<a href="mailto:&#98;&#x64;&#x70;&#x61;&#x79;&#x6e;&#101;&#x40;&#97;&#x63;&#109;&#x2e;&#111;&#114;&#x67;">&#98;&#x64;&#x70;&#x61;&#x79;&#x6e;&#101;&#x40;&#97;&#x63;&#109;&#x2e;&#111;&#114;&#x67;</a>)</li>
</ul>
</li>
<li><ul>
<li></li>
</ul>
</li>
<li><ul>
<li>Refurbished for modern QEMU by Valerio Aimale (<a href="mailto:&#x76;&#x61;&#x6c;&#x65;&#x72;&#105;&#x6f;&#x40;&#x61;&#x69;&#109;&#x61;&#108;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#x76;&#x61;&#x6c;&#x65;&#x72;&#105;&#x6f;&#x40;&#x61;&#x69;&#109;&#x61;&#108;&#x65;&#46;&#x63;&#x6f;&#x6d;</a>), in 2015</li>
</ul>
</li>
<li>*&#x2F;</li>
<li>+#include &lt;stdlib.h&gt;<br>+#include &lt;stdio.h&gt;<br>+#include &lt;string.h&gt;<br>+#include &lt;pthread.h&gt;<br>+#include &lt;sys&#x2F;types.h&gt;<br>+#include &lt;sys&#x2F;socket.h&gt;<br>+#include &lt;sys&#x2F;un.h&gt;<br>+#include &lt;unistd.h&gt;<br>+#include &lt;signal.h&gt;<br>+#include &lt;stdint.h&gt;<br>+#include &lt;poll.h&gt;</li>
<li>+#include “memory-access.h”<br>+#include “exec&#x2F;cpu-common.h”<br>+#include “libvmi_request.h”</li>
<li></li>
<li>+static uint64_t<br>+connection_read_memory (uint64_t user_paddr, void *buf, uint64_t user_len)<br>+{</li>
<li>hwaddr paddr &#x3D; (hwaddr) user_paddr;</li>
<li>hwaddr len &#x3D; (hwaddr) user_len;</li>
<li>void *guestmem &#x3D; cpu_physical_memory_map(paddr, &amp;len, 0);</li>
<li>if (!guestmem){</li>
<li><pre><code>   return 0;
</code></pre>
</li>
<li>}</li>
<li>memcpy(buf, guestmem, len);</li>
<li>cpu_physical_memory_unmap(guestmem, len, 0, len);</li>
<li></li>
<li>return len;<br>+}</li>
<li>+static uint64_t<br>+connection_write_memory (uint64_t user_paddr, void *buf, uint64_t user_len)<br>+{</li>
<li>hwaddr paddr &#x3D; (hwaddr) user_paddr;</li>
<li>hwaddr len &#x3D; (hwaddr) user_len;</li>
<li>void *guestmem &#x3D; cpu_physical_memory_map(paddr, &amp;len, 1);</li>
<li>if (!guestmem){</li>
<li><pre><code>   return 0;
</code></pre>
</li>
<li>}</li>
<li>memcpy(guestmem, buf, len);</li>
<li>cpu_physical_memory_unmap(guestmem, len, 0, len);</li>
<li></li>
<li>return len;<br>+}</li>
<li>+static void<br>+send_success_ack (int connection_fd)<br>+{</li>
<li>uint8_t success &#x3D; 1;</li>
<li>int nbytes &#x3D; write(connection_fd, &amp;success, 1);</li>
<li>if (1 !&#x3D; nbytes){</li>
<li><pre><code>   fprintf(stderr, &quot;Qemu pmemaccess: failed to send success ack\n&quot;);
</code></pre>
</li>
<li>}<br>+}</li>
<li>+static void<br>+send_fail_ack (int connection_fd)<br>+{</li>
<li>uint8_t fail &#x3D; 0;</li>
<li>int nbytes &#x3D; write(connection_fd, &amp;fail, 1);</li>
<li>if (1 !&#x3D; nbytes){</li>
<li><pre><code>   fprintf(stderr, &quot;Qemu pmemaccess: failed to send fail ack\n&quot;);
</code></pre>
</li>
<li>}<br>+}</li>
<li>+static void<br>+connection_handler (int connection_fd)<br>+{</li>
<li>int nbytes;</li>
<li>struct request req;</li>
<li>struct pollfd *fds &#x3D; calloc(1, sizeof(struct pollfd));</li>
<li>if (!fds)</li>
<li>{</li>
<li><pre><code>   fprintf(stderr, &quot;Allocating pollfd failed\n&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li>fds[0].fd &#x3D; connection_fd;</li>
<li>fds[0].events &#x3D; POLLIN | POLLERR | POLLHUP | POLLNVAL;</li>
<li></li>
<li>while (1){</li>
<li><pre><code>   // poll on our connection fd
</code></pre>
</li>
<li><pre><code>   int nb_modified = poll(fds, 1, -1);
</code></pre>
</li>
<li><pre><code>   if (nb_modified &lt; 0)
</code></pre>
</li>
<li><pre><code>   &#123;
</code></pre>
</li>
<li><pre><code>       // poll failed
</code></pre>
</li>
<li><pre><code>       fprintf(stderr, &quot;Poll failed on vmi socket: %s\n&quot;, strerror(errno));
</code></pre>
</li>
<li><pre><code>       continue;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li><pre><code>   else if (nb_modified == 0)
</code></pre>
</li>
<li><pre><code>   &#123;
</code></pre>
</li>
<li><pre><code>       // timeout
</code></pre>
</li>
<li><pre><code>       fprintf(stderr, &quot;Poll timeout on vmi socket\n&quot;);
</code></pre>
</li>
<li><pre><code>       continue;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li><pre><code>   else if (fds[0].revents &amp; POLLERR
</code></pre>
</li>
<li><pre><code>           || fds[0].revents &amp; POLLHUP
</code></pre>
</li>
<li><pre><code>           || fds[0].revents &amp; POLLNVAL)
</code></pre>
</li>
<li><pre><code>   &#123;
</code></pre>
</li>
<li><pre><code>       // error
</code></pre>
</li>
<li><pre><code>       fprintf(stderr, &quot;Poll error on vmi socket\n&quot;);
</code></pre>
</li>
<li><pre><code>       break;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li><pre><code>   else if (fds[0].revents &amp; POLLIN)
</code></pre>
</li>
<li><pre><code>   &#123;
</code></pre>
</li>
<li><pre><code>       // client request should match the struct request format
</code></pre>
</li>
<li><pre><code>       nbytes = read(connection_fd, &amp;req, sizeof(struct request));
</code></pre>
</li>
<li><pre><code>       if (nbytes == -1 || nbytes != sizeof(struct request))&#123;
</code></pre>
</li>
<li><pre><code>           // error
</code></pre>
</li>
<li><pre><code>           continue;
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       else if (req.type == 0)&#123;
</code></pre>
</li>
<li><pre><code>           // request to quit, goodbye
</code></pre>
</li>
<li><pre><code>           break;
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       else if (req.type == 1)&#123;
</code></pre>
</li>
<li><pre><code>           // request to read
</code></pre>
</li>
<li><pre><code>           char *buf = malloc(req.length + 1);
</code></pre>
</li>
<li><pre><code>           nbytes = connection_read_memory(req.address, buf, req.length);
</code></pre>
</li>
<li><pre><code>           if (nbytes != req.length)&#123;
</code></pre>
</li>
<li><pre><code>               // read failure, return failure message
</code></pre>
</li>
<li><pre><code>               buf[req.length] = 0; // set last byte to 0 for failure
</code></pre>
</li>
<li><pre><code>               nbytes = write(connection_fd, buf, 1);
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>           else&#123;
</code></pre>
</li>
<li><pre><code>               // read success, return bytes
</code></pre>
</li>
<li><pre><code>               buf[req.length] = 1; // set last byte to 1 for success
</code></pre>
</li>
<li><pre><code>               nbytes = write(connection_fd, buf, nbytes + 1);
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>           free(buf);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       else if (req.type == 2)&#123;
</code></pre>
</li>
<li><pre><code>           // request to write
</code></pre>
</li>
<li><pre><code>           void *write_buf = malloc(req.length);
</code></pre>
</li>
<li><pre><code>           nbytes = read(connection_fd, write_buf, req.length);
</code></pre>
</li>
<li><pre><code>           if (nbytes != req.length)&#123;
</code></pre>
</li>
<li><pre><code>               // failed reading the message to write
</code></pre>
</li>
<li><pre><code>               send_fail_ack(connection_fd);
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>           else&#123;
</code></pre>
</li>
<li><pre><code>               // do the write
</code></pre>
</li>
<li><pre><code>               nbytes = connection_write_memory(req.address, write_buf, req.length);
</code></pre>
</li>
<li><pre><code>               if (nbytes == req.length)&#123;
</code></pre>
</li>
<li><pre><code>                   send_success_ack(connection_fd);
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li><pre><code>               else&#123;
</code></pre>
</li>
<li><pre><code>                   send_fail_ack(connection_fd);
</code></pre>
</li>
<li><pre><code>               &#125;
</code></pre>
</li>
<li><pre><code>           &#125;
</code></pre>
</li>
<li><pre><code>           free(write_buf);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>       else&#123;
</code></pre>
</li>
<li><pre><code>           // unknown command
</code></pre>
</li>
<li><pre><code>           fprintf(stderr, &quot;Qemu pmemaccess: ignoring unknown command (%&quot; PRIu64 &quot;)\n&quot;, req.type);
</code></pre>
</li>
<li><pre><code>           char *buf = malloc(1);
</code></pre>
</li>
<li><pre><code>           buf[0] = 0;
</code></pre>
</li>
<li><pre><code>           nbytes = write(connection_fd, buf, 1);
</code></pre>
</li>
<li><pre><code>           free(buf);
</code></pre>
</li>
<li><pre><code>       &#125;
</code></pre>
</li>
<li><pre><code>   &#125;
</code></pre>
</li>
<li>}</li>
<li></li>
<li>free(fds);</li>
<li>close(connection_fd);<br>+}</li>
<li>+static void *<br>+memory_access_thread (void *p)<br>+{</li>
<li>int connection_fd;</li>
<li>struct pmemaccess_args *pargs &#x3D; (struct pmemaccess_args *)p;</li>
<li></li>
<li>&#x2F;&#x2F; accept incoming connections</li>
<li>connection_fd &#x3D; accept(pargs-&gt;socket_fd, (struct sockaddr *) pargs-&gt;address, &amp;(pargs-&gt;address_length));</li>
<li>connection_handler(connection_fd);</li>
<li></li>
<li>close(pargs-&gt;socket_fd);</li>
<li>unlink(pargs-&gt;path);</li>
<li>free(pargs-&gt;path);</li>
<li>free(pargs-&gt;address);</li>
<li>free(pargs);</li>
<li>return NULL;<br>+}</li>
<li>+void<br>+qmp_pmemaccess (const char *path, Error **errp)<br>+{</li>
<li>pthread_t thread;</li>
<li>sigset_t set, oldset;</li>
<li>struct pmemaccess_args *pargs;</li>
<li></li>
<li>&#x2F;&#x2F; create the args struct</li>
<li>pargs &#x3D; (struct pmemaccess_args *) malloc(sizeof(struct pmemaccess_args));</li>
<li>if (pargs &#x3D;&#x3D; NULL){</li>
<li><pre><code>   error_setg(errp, &quot;Qemu pmemaccess: malloc failed&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li></li>
<li>pargs-&gt;errp &#x3D; errp;</li>
<li>&#x2F;&#x2F; create a copy of path that we can safely use</li>
<li>size_t path_size &#x3D; strlen(path);</li>
<li>pargs-&gt;path &#x3D; malloc(path_size + 1);</li>
<li>memcpy(pargs-&gt;path, path, path_size);</li>
<li>pargs-&gt;path[path_size] &#x3D; ‘\0’;</li>
<li></li>
<li>&#x2F;&#x2F; create socket</li>
<li>pargs-&gt;socket_fd &#x3D; socket(PF_UNIX, SOCK_STREAM, 0);</li>
<li>if (pargs-&gt;socket_fd &lt; 0){</li>
<li><pre><code>   error_setg(pargs-&gt;errp, &quot;Qemu pmemaccess: socket failed&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li>&#x2F;&#x2F; unlink path if already exists</li>
<li>unlink(path);</li>
<li>&#x2F;&#x2F; bind socket</li>
<li>pargs-&gt;address &#x3D; malloc(sizeof(struct sockaddr_un));</li>
<li>if (pargs-&gt;address &#x3D;&#x3D; NULL){</li>
<li><pre><code>   error_setg(pargs-&gt;errp, &quot;Qemu pmemaccess: malloc failed&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li>pargs-&gt;address-&gt;sun_family &#x3D; AF_UNIX;</li>
<li>pargs-&gt;address_length &#x3D; sizeof(pargs-&gt;address-&gt;sun_family) + sprintf(pargs-&gt;address-&gt;sun_path, “%s”, (char *) pargs-&gt;path);</li>
<li>if (bind(pargs-&gt;socket_fd, (struct sockaddr *) pargs-&gt;address, pargs-&gt;address_length) !&#x3D; 0){</li>
<li><pre><code>   printf(&quot;could not bind\n&quot;);
</code></pre>
</li>
<li><pre><code>   error_setg(pargs-&gt;errp, &quot;Qemu pmemaccess: bind failed&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li></li>
<li>&#x2F;&#x2F; listen</li>
<li>if (listen(pargs-&gt;socket_fd, 0) !&#x3D; 0){</li>
<li><pre><code>   error_setg(pargs-&gt;errp, &quot;Qemu pmemaccess: listen failed&quot;);
</code></pre>
</li>
<li><pre><code>   return;
</code></pre>
</li>
<li>}</li>
<li></li>
<li>&#x2F;&#x2F; start the thread</li>
<li>sigfillset(&amp;set);</li>
<li>pthread_sigmask(SIG_SETMASK, &amp;set, &amp;oldset);</li>
<li>pthread_create(&amp;thread, NULL, memory_access_thread, pargs);</li>
<li>pthread_sigmask(SIG_SETMASK, &amp;oldset, NULL);<br>+}<br>diff –git a&#x2F;memory-access.h b&#x2F;memory-access.h<br>new file mode 100644<br>index 0000000000..21c713735d<br>— &#x2F;dev&#x2F;null<br>+++ b&#x2F;memory-access.h<br>@@ -0,0 +1,24 @@<br>+&#x2F;*</li>
<li><ul>
<li>Open A UNIX Socket access to physical memory</li>
</ul>
</li>
<li><ul>
<li></li>
</ul>
</li>
<li><ul>
<li>Author: Valerio G. Aimale <a href="mailto:&#118;&#x61;&#x6c;&#x65;&#x72;&#105;&#x6f;&#x40;&#x61;&#105;&#x6d;&#x61;&#108;&#x65;&#46;&#x63;&#111;&#109;">&#118;&#x61;&#x6c;&#x65;&#x72;&#105;&#x6f;&#x40;&#x61;&#105;&#x6d;&#x61;&#108;&#x65;&#46;&#x63;&#111;&#109;</a></li>
</ul>
</li>
<li>*&#x2F;</li>
<li>+#ifndef MEMORY_ACCESS_H<br>+#define MEMORY_ACCESS_H</li>
<li>+#include &lt;sys&#x2F;socket.h&gt;<br>+#include “qemu&#x2F;osdep.h”<br>+#include “qapi&#x2F;error.h”</li>
<li>+void qmp_pmemaccess (const char *path, Error **errp);</li>
<li>+struct pmemaccess_args {</li>
<li>int socket_fd;</li>
<li>struct sockaddr_un *address;</li>
<li>socklen_t address_length;</li>
<li>char *path;</li>
<li>Error **errp;<br>+};</li>
<li>+#endif &#x2F;* MEMORY_ACCESS_H *&#x2F;<br>diff –git a&#x2F;monitor&#x2F;hmp-cmds.c b&#x2F;monitor&#x2F;hmp-cmds.c<br>index 5ca3ebe942..9cc404db5e 100644<br>— a&#x2F;monitor&#x2F;hmp-cmds.c<br>+++ b&#x2F;monitor&#x2F;hmp-cmds.c<br>@@ -57,6 +57,7 @@<br>#include “hw&#x2F;rdma&#x2F;rdma.h”<br>#include “migration&#x2F;snapshot.h”<br>#include “migration&#x2F;misc.h”<br>+#include “memory-access.h”#ifdef CONFIG_SPICE<br>#include &lt;spice&#x2F;enums.h&gt;</li>
</ul>
<p>@@ -113,9 +114,10 @@ void hmp_info_version(Monitor *mon, const QDict *qdict)</p>
<pre><code> info = qmp_query_version(NULL);
</code></pre>
<ul>
<li>monitor_printf(mon, “%” PRId64 “.%” PRId64 “.%” PRId64 “%s\n”,</li>
</ul>
<ul>
<li>monitor_printf(mon, “%” PRId64 “.%” PRId64 “.%” PRId64 “%s %s\n”,<br>           info-&gt;qemu-&gt;major, info-&gt;qemu-&gt;minor, info-&gt;qemu-&gt;micro,</li>
</ul>
<ul>
<li><pre><code>              info-&gt;package);
</code></pre>
</li>
</ul>
<ul>
<li><pre><code>              info-&gt;package,
</code></pre>
</li>
<li><pre><code>              &quot;vmi&quot;);
</code></pre>
   qapi_free_VersionInfo(info);</li>
</ul>
<p> }<br>@@ -1250,6 +1252,15 @@ void hmp_pmemsave(Monitor *mon, const QDict *qdict)<br>     hmp_handle_error(mon, &amp;err);<br> }</p>
<p>+void hmp_pmemaccess(Monitor *mon, const QDict *qdict)<br>+{</p>
<ul>
<li>const char *path &#x3D; qdict_get_str(qdict, “path”);</li>
<li>Error *err &#x3D; NULL;</li>
<li></li>
<li>qmp_pmemaccess(path, &amp;err);</li>
<li>hmp_handle_error(mon, &amp;err);<br>+}</li>
<li>void hmp_ringbuf_write(Monitor *mon, const QDict *qdict)<br>{<br>const char *chardev &#x3D; qdict_get_str(qdict, “device”);<br>diff –git a&#x2F;qapi&#x2F;Makefile.objs b&#x2F;qapi&#x2F;Makefile.objs<br>index c5a29e86e2..fa7aa0c72d 100644<br>— a&#x2F;qapi&#x2F;Makefile.objs<br>+++ b&#x2F;qapi&#x2F;Makefile.objs<br>@@ -8,7 +8,7 @@ util-obj-y +&#x3D; qapi-util.o<br>QAPI_COMMON_MODULES &#x3D; audio authz block-core block char common crypto<br>QAPI_COMMON_MODULES +&#x3D; dump introspect job machine migration misc net<br>QAPI_COMMON_MODULES +&#x3D; qdev qom rdma rocker run-state sockets tpm<br>-QAPI_COMMON_MODULES +&#x3D; trace transaction ui<br>+QAPI_COMMON_MODULES +&#x3D; trace transaction ui libvmi<br>QAPI_TARGET_MODULES &#x3D; machine-target misc-target<br>QAPI_MODULES &#x3D; $(QAPI_COMMON_MODULES) $(QAPI_TARGET_MODULES)</li>
</ul>
<p>diff –git a&#x2F;qapi&#x2F;libvmi.json b&#x2F;qapi&#x2F;libvmi.json<br>new file mode 100644<br>index 0000000000..54deaa31d8<br>— &#x2F;dev&#x2F;null<br>+++ b&#x2F;qapi&#x2F;libvmi.json<br>@@ -0,0 +1,41 @@<br>+# -<em>- Mode: Python -</em>-<br>+#<br>+<br>+##<br>+# &#x3D; libvmi memory access<br>+##</p>
<p>+<br>+##<br>+# @pmemaccess:<br>+#<br>+# Open A UNIX Socket access to physical memory<br>+#<br>+# @path: the name of the UNIX socket pipe<br>+#<br>+# Returns: Nothing on success<br>+#<br>+# Since: 2.4.0.1<br>+#<br>+# Notes: Derived from previously existing patches. When command<br>+# succeeds connect to the open socket. Write a binary structure to<br>+# the socket as:<br>+#<br>+# struct request {<br>+#     uint64_t type;   &#x2F;&#x2F; 0 quit, 1 read, 2 write, … rest reserved<br>+#     uint64_t address;   &#x2F;&#x2F; address to read from OR write to<br>+#     uint64_t length;    &#x2F;&#x2F; number of bytes to read OR write<br>+# };<br>+#<br>+# If it is a read operation, Qemu will return lenght+1 bytes. Read lenght+1<br>+# bytes. the last byte will be a 1 for success, or a 0 for failure.<br>+#<br>+# Example:<br>+#<br>+# -&gt; { “execute”: “pmemaccess”,<br>+#     “arguments”: { “path”: “&#x2F;tmp&#x2F;physical-mem-socket” } }<br>+# &lt;- { “return”: {} }<br>+#<br>+##<br>+{ ‘command’: ‘pmemaccess’,</p>
<ul>
<li>‘data’: {‘path’: ‘str’} }</li>
<li>diff –git a&#x2F;qapi&#x2F;qapi-schema.json b&#x2F;qapi&#x2F;qapi-schema.json<br>index 38af54d6b3..5ca4bf2832 100644<br>— a&#x2F;qapi&#x2F;qapi-schema.json<br>+++ b&#x2F;qapi&#x2F;qapi-schema.json<br>@@ -105,3 +105,4 @@<br>{ ‘include’: ‘misc.json’ }<br>{ ‘include’: ‘misc-target.json’ }<br>{ ‘include’: ‘audio.json’ }<h2 id="‘include’-‘libvmi-json’"><a href="#‘include’-‘libvmi-json’" class="headerlink" title="+{ ‘include’: ‘libvmi.json’ }"></a>+{ ‘include’: ‘libvmi.json’ }</h2>2.11.0</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Gan Chengyu
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="http://example.com/articles/2022/06/27/libvmi-patch/" title="libvmi_patch">http://example.com/articles/2022/06/27/libvmi-patch/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/qemu/" rel="tag"># qemu</a>
              <a href="/tags/kvm/" rel="tag"># kvm</a>
              <a href="/tags/libvmi/" rel="tag"># libvmi</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/articles/2022/06/24/virtual-summary/" rel="prev" title="virtual-summary">
                  <i class="fa fa-chevron-left"></i> virtual-summary
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/articles/2022/06/28/A%20Interesting%20expr%20on%20LibVMI%20adapting/" rel="next" title="A Interesting expr on LibVMI adapting">
                  A Interesting expr on LibVMI adapting <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gan Chengyu</span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
-->

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
